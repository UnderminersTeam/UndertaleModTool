/*
  .______________________________________________________|_._._._._._._._._._.
   \_____________________________________________________|_#_#_#_#_#_#_#_#_#_|
                                                         l                                                                                  
  built for Samurai Gunn 2, version EA6_2

*/
using System;
using System.IO;
using System.Drawing;
using System.Drawing.Imaging;
using System.Drawing.Drawing2D;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using UndertaleModLib.Util;

// main
EnsureDataLoaded();
// FilePath is the full file path to the currently-opened data.win file
string game_dir = Path.GetDirectoryName(FilePath);
string mods_dir = Path.Combine(game_dir, @"mods\");
List<string> embedded_texture_successes = new List<string>();
List<string> embedded_texture_failures = new List<string>();
List<string> sprite_successes = new List<string>();
List<string> sprite_failures = new List<string>();
List<string> audio_successes = new List<string>();
List<string> audio_failures = new List<string>();
//
// for each mod folder found
foreach (string mod_dir in Directory.GetDirectories(mods_dir))
{
	//
	string mod_embedded_textures = Path.Combine(mod_dir, @"embedded_textures\");
	if (Directory.Exists(mod_embedded_textures))
	{
		// example string          match?
		//  @"path\0.png"           YES
		//  @"path\65536.png",      YES
		//  @"path\AbCdEf-485.png"  NO
		Regex embedded_texture_file_regex = new Regex(@"^.+\\(\d+)\.png$", 
			RegexOptions.Compiled | RegexOptions.IgnoreCase);
		//
		// for each embedded texture file found on disk, import it
		foreach (string file_path in Directory.GetFiles(mod_embedded_textures, @"*.png")
			.Where(path => embedded_texture_file_regex.IsMatch(path)).ToList())
		{
			try
			{
				// get idx
				// if there was a match, this match structure is guaranteed
				string tex_idx_str = embedded_texture_file_regex.Matches(file_path)[0].Groups[1].Value;
				int tex_idx = Int32.Parse(tex_idx_str);
				// read file
				UndertaleEmbeddedTexture target = Data.EmbeddedTextures[tex_idx];
				byte[] data = File.ReadAllBytes(file_path);
				// TODO: check if has PNG file header: // PNG header:  byte[] [0x89 0x50 0x4E 0x47 0x0D 0x0A 0x1A 0x0A]
				// TODO: check if can be loaded into Image // Image.FromStream(new MemoryStream(bytes));
				// import into UMT
				target.TextureData.TextureBlob = data;
				//
				embedded_texture_successes.Add(file_path.Substring(mods_dir.Length));
			}
			catch (Exception ex)
			{
				embedded_texture_failures.Add(file_path.Substring(mods_dir.Length));
			}
		}
	}
	//
	string mod_sprites = Path.Combine(mod_dir, @"sprites\");
	if (Directory.Exists(mod_sprites))
	{
		// example string               match?
		//  @"path\helmsley_walk_0.png"  YES
		//  @"path\hayao_slide.png"      NO
		//  @"path\0.png"                NO
		Regex sprite_file_regex = new Regex(@"^.+\\([^\\]+)_(\d+)\.png$", RegexOptions.Compiled | RegexOptions.IgnoreCase);
		//
		// for each sprite file in the Sprites folder, import it
		foreach (string file_path in Directory.GetFiles(mod_sprites, @"*.png")
			.Where(path => sprite_file_regex.IsMatch(path)).ToList())
		{
			try
			{
				//   parse file_path similar to "<SPRT>_#.png"
				MatchCollection matches = sprite_file_regex.Matches(file_path);
				string spr_name = matches[0].Groups[1].Value;
				string spr_idx_str = matches[0].Groups[2].Value;
				int spr_idx = Int32.Parse(spr_idx_str);
				//
				//   if file name matches an existing sprite by name, ...
				UndertaleSprite sprite = Data.Sprites.ByName(spr_name);
				//   and its frame number matches an existing texture page item index (and underlying texture) from said sprite
				UndertaleSprite.TextureEntry tex_entry = sprite.Textures[spr_idx];
				UndertaleTexturePageItem tex_page_item = tex_entry.Texture;
				// UndertaleEmbeddedTexture tex_page = tex_page_item.TexturePage;
				//
				//     load png file as bitmap obj
				byte[] data = File.ReadAllBytes(file_path);
				//     load sprite's texture as bitmap obj
				Image new_img = Image.FromStream(new MemoryStream(data));
				//     blit new sprite into texture and save
				tex_page_item.ReplaceTexture(new_img); // warning; sprite
				//
				//
				sprite_successes.Add(file_path.Substring(mods_dir.Length));
			}
			catch(Exception ex)
			{
				sprite_failures.Add(file_path.Substring(mods_dir.Length));
			}
		}
	}
	//
	// simple file copy
	string mod_audio_static = Path.Combine(mod_dir, @"audio\static");
	string mod_audio_streaming = Path.Combine(mod_dir, @"audio\streaming");
	string audio_static_dest = Path.Combine(game_dir, @"data\audio\static");
	string audio_streaming_dest = Path.Combine(game_dir, @"data\audio\streaming");
	//
	// for each audio file, copy into game audio folder (overwrite file)
	if (Directory.Exists(mod_audio_static))
	{
		foreach (string file_path in Directory.GetFiles(mod_audio_static))
		{
			try
			{
				string fname = Path.GetFileName(file_path);
				string dest = Path.Combine(audio_static_dest, fname);
				File.Copy(file_path, dest, true);
				//
				audio_successes.Add(file_path.Substring(mods_dir.Length));
			}
			catch(Exception ex)
			{
				audio_failures.Add(file_path.Substring(mods_dir.Length));
			}
		}
	}
	if (Directory.Exists(mod_audio_streaming))
	{
		foreach (string file_path in Directory.GetFiles(mod_audio_streaming))
		{
			try
			{
				string fname = Path.GetFileName(file_path);
				string dest = Path.Combine(audio_streaming_dest, fname);
				File.Copy(file_path, dest, true);
				//
				audio_successes.Add(file_path.Substring(mods_dir.Length));
			}
			catch(Exception ex)
			{
				audio_failures.Add(file_path.Substring(mods_dir.Length));
			}
		}
	}
}
// report
string report = "";

int success_count = embedded_texture_successes.Count + sprite_successes.Count + audio_successes.Count;
int failure_count = embedded_texture_failures.Count + sprite_failures.Count + audio_failures.Count;
if (success_count > 0)
{
	report += "Succeeded ("+success_count+"):"
	+ "\n" + String.Join("\n",embedded_texture_successes)
	+ "\n" + String.Join("\n",sprite_successes)
	+ "\n" + String.Join("\n",audio_successes);
}
if (failure_count > 0)
{
	report += "\n\nFailed ("+failure_count+"):"
	+ "\n" + String.Join("\n",embedded_texture_failures)
	+ "\n" + String.Join("\n",sprite_failures)
	+ "\n" + String.Join("\n",audio_failures);
}
ScriptMessage(report);

